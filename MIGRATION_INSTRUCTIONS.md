# تعليمات تطبيق ترحيل قاعدة البيانات

## المشكلة
1. خطأ `PGRST205: Could not find the table 'public.shift_closure_expenses'` يحدث لأن جدول `shift_closure_expenses` لم يتم إنشاؤه بعد في قاعدة البيانات.
2. وجود ورديات صباحية مكررة في النظام.
3. عدم تصفير المصروفات بعد إغلاق الوردية.

## الحل

### الطريقة الأولى: عبر Supabase CLI (مفضلة)

1. **تسجيل الدخول إلى Supabase:**
   ```bash
   npx supabase login
   ```

2. **ربط المشروع:**
   ```bash
   npx supabase link --project-ref kktnwrptrtldvkvxlshd
   ```

3. **تطبيق الترحيلات:**
   ```bash
   npx supabase db push
   ```

### الطريقة الثانية: عبر لوحة تحكم Supabase

1. اذهب إلى [supabase.com](https://supabase.com)
2. سجل دخولك وافتح مشروعك
3. اذهب إلى **SQL Editor**

4. **أولاً: تطبيق الترحيل الأول (إنشاء جدول المصروفات):**
   انسخ والصق محتوى ملف `supabase/migrations/20250821120000_add_shift_closure_expenses.sql`
   اضغط **Run**

5. **ثانياً: تطبيق الترحيل الثاني (تنظيف الورديات المكررة):**
   انسخ والصق محتوى ملف `supabase/migrations/20250821130000_cleanup_duplicate_shifts.sql`
   اضغط **Run**

### الطريقة الثالثة: عبر psql مباشرة

إذا كان لديك وصول مباشر لقاعدة البيانات:

```bash
psql "postgresql://postgres:[YOUR_PASSWORD]@db.kktnwrptrtldvkvxlshd.supabase.co:5432/postgres" -f supabase/migrations/20250821120000_add_shift_closure_expenses.sql
psql "postgresql://postgres:[YOUR_PASSWORD]@db.kktnwrptrtldvkvxlshd.supabase.co:5432/postgres" -f supabase/migrations/20250821130000_cleanup_duplicate_shifts.sql
```

## ما تفعله الترحيلات

### الترحيل الأول: `20250821120000_add_shift_closure_expenses.sql`
1. **إنشاء جدول `shift_closure_expenses`:**
   - يحفظ تفاصيل كل مصروفة مرتبطة بوردية محددة
   - يحتوي على `shift_closure_id` لربط المصروفات بالوردية
   - يحفظ `original_expense_id` للرجوع للمصروفة الأصلية

2. **إضافة فهارس للسرعة:**
   - فهرس على `shift_closure_id` للبحث السريع

3. **تفعيل Row Level Security (RLS):**
   - سياسات أساسية للقراءة والكتابة

### الترحيل الثاني: `20250821130000_cleanup_duplicate_shifts.sql`
1. **تنظيف الورديات المكررة:**
   - يحذف الورديات المكررة لنفس التاريخ ونوع الوردية
   - يحتفظ بأحدث وردية فقط لكل تاريخ/نوع

2. **منع التكرار في المستقبل:**
   - يضيف قيد فريد `unique_shift_date_type` لمنع التكرار

3. **تحسين تصفير المصروفات:**
   - ينشئ trigger تلقائي لحذف المصروفات عند إغلاق الوردية
   - يضيف فهارس لتحسين الأداء

## بعد تطبيق الترحيلات

- ✅ إغلاق الوردية سيعمل بدون أخطاء
- ✅ الورديات المكررة ستُحذف تلقائياً
- ✅ المصروفات ستُحفظ في الجدول الجديد
- ✅ المصروفات ستُحذف تلقائياً من الشاشة الرئيسية
- ✅ عند عرض الوردية ستظهر قائمة المصروفات المفصلة
- ✅ لن يتم إنشاء ورديات مكررة في المستقبل

## ملاحظات مهمة

- **الورديات المكررة:** سيتم حذف الورديات القديمة تلقائياً والاحتفاظ بأحدث واحدة فقط
- **المصروفات:** ستُحذف تلقائياً من الشاشة الرئيسية عند إغلاق الوردية
- **الأمان:** التطبيق يتعامل مع عدم وجود الجدول بشكل آمن
- **الأداء:** الفهارس الجديدة ستحسن سرعة الاستعلامات

## إذا استمرت المشاكل

1. تحقق من Console المتصفح للأخطاء
2. تأكد من تطبيق كلا الترحيلين
3. أعد تشغيل التطبيق بعد تطبيق الترحيلات
